<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatPDF ìŠ¤íƒ€ì¼ ìš”ì•½ ë° QA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
</head>

<body>
    <div class="container-fluid h-100">
        <div class="row h-100" style="min-height: 0;">
            <div class="col-md-2 sidebar">
                <form id="uploadForm" enctype="multipart/form-data" style="display: none;">
                    <input type="file" name="pdf_file" id="pdfInput" accept=".pdf">
                    <input type="hidden" name="summary_type" value="simple">
                </form>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" id="addDocumentBtn"><i
                            class="bi bi-file-earmark-plus"></i> ë¬¸ì„œ ì¶”ê°€</button>
                    <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-folder-plus"></i> í´ë” ìƒì„±</button>
                </div>
                <h6><i class="bi bi-folder-fill me-2"></i>ë¬¸ì„œ ì´ë ¥</h6>
                <ul class="list-group list-group-flush" id="document-history-list">
                    {% for item in history %}
                    <li class="list-group-item small text-truncate">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="col-md-5 pdf-viewer">
                {% if filepath %}
                <iframe id="pdf-frame"
                    src="/static/pdfjs/web/viewer.html?file=/static/{{ filepath | replace('\\', '/') }}#page=1"></iframe>
                {% else %}
                <div class="empty-upload text-center w-100">
                    <i class="bi bi-file-earmark-arrow-up display-1 text-secondary"></i>
                    <h5 class="mt-3 text-muted">PDF ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h5>
                    <p class="small text-secondary">ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ìš”ì•½ê³¼ Q&A ê¸°ëŠ¥ì„ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br>
                        ì—¬ê¸°ì— PDF ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                    </p>
                </div>

                {% endif %}
            </div>

            <div class="col-md-5 chat-box d-flex flex-column" style="height: 100vh; min-height: 0;">
                {# ğŸŒŸ ì±„íŒ… ë¡œë”© ì˜¤ë²„ë ˆì´ ì¶”ê°€ #}
                <div id="chat-loading-overlay">
                    <div class="loading-spinner"></div>
                    <span>ë‹µë³€ ìƒì„± ì¤‘...</span>
                </div>

                {# ğŸŒŸğŸŒŸğŸŒŸ ê°„ë‹¨ ìš”ì•½ ì„¹ì…˜ ì „ì²´ ì œê±° (id="summary-box" div ì‚­ì œ) ğŸŒŸğŸŒŸğŸŒŸ #}

                <div class="chat-history" style="flex:1 1 auto; min-height: 0; overflow-y: auto;">
                    <div id="summary-container" class="chat-bubble d-flex align-items-start mb-3"
                        style="display: none;">
                        <div id="summary-content"
                            class="message bg-white border-start border-primary border-4 shadow-sm">
                            <!-- preview_summary ë˜ëŠ” full_summary ê°€ ì´ê³³ì— ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    {# ğŸŒŸğŸŒŸğŸŒŸ ë¬¸ì„œ ìš”ì•½ ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ìœ„í•œ ì„ì‹œ ë©”ì‹œì§€ #}
                    <div id="pdf-processing-message" style="display: none;">
                        <div
                            class="message bg-white border-start border-primary border-4 shadow-sm d-flex align-items-center justify-content-center">
                            <span class="loading-spinner"></span>
                            <span>ë¬¸ì„œ ìš”ì•½ ì¤‘...</span>
                        </div>
                    </div>
                    {% if not chat_history %}
                    <!-- ì±„íŒ…ì´ ë¹„ì–´ìˆì„ ë•Œ í‘œì‹œ -->
                    <div class="chat-placeholder text-center text-muted" id="chat-placeholder">
                        <i class="bi bi-chat-square-dots display-1"></i>
                        <h5 class="mt-3">ë¬¸ì„œì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”</h5>
                        <p class="small">AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                    </div>
                    {% else %}
                    {% for role, message in chat_history %}
                    {% if role == 'ì‹œìŠ¤í…œ' %}
                    <div class="chat-bubble ai">
                        <img src="{{ url_for('static', filename='img/ai-avatar.png') }}" alt="AI í”„ë¡œí•„"
                            class="ai-avatar me-2">
                        <div class="message bg-white border-start border-primary border-4 shadow-sm">{{message | nl2br |
                            safe}}</div>
                    </div>
                    {% elif role == 'ì¶”ì²œì§ˆë¬¸' %}
                    <div class="chat-bubble ai ai-recommend">
                        <div class="message bg-white border-start border-primary border-4 shadow-sm">
                            <div class="fw-bold mb-2">ğŸ“Œ ì¶”ì²œ ì§ˆë¬¸:</div>
                            <div class="d-flex flex-wrap gap-2">
                                {% for question in message %}
                                <button type="button"
                                    class="btn btn-outline-secondary btn-sm recommended-question-btn mb-1"
                                    data-question="{{ question.text }}">
                                    {{ question.text }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% elif role == 'user' %}
                    <div class="chat-bubble user">
                        <div class="message">{{message | nl2br}}</div>
                    </div>
                    {% elif role == 'ai' %}
                    <div class="chat-bubble ai d-flex align-items-start">
                        <img src="{{ url_for('static', filename='img/ai-avatar.png') }}" alt="AI í”„ë¡œí•„"
                            class="ai-avatar me-2">
                        <div class="message bg-white border-start border-primary border-4 shadow-sm">
                            {{ message.text | nl2br }}
                            {% if message.page %}
                            <span class="badge bg-primary-subtle text-primary-emphasis ms-2 p-0 mb-1 page-badge"
                                data-page="{{ message.page }}" style="cursor: pointer;" data-bs-toggle="tooltip"
                                title="í´ë¦­ì‹œ í•´ë‹¹ PDF í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.">
                                p.{{ message.page }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
                <div class="chat-input" style="flex-shrink: 0;">
                    <form id="mainChatForm">
                        <input type="hidden" name="pdf_path" value="{{ filepath }}" id="currentPdfPathInput">
                        <div class="input-group">
                            <input type="text" name="user_question" class="form-control" placeholder="ë¬¸ì„œì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”"
                                required>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- 1) í”„ë¡œí•„ í† ê¸€ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •) -->
    <button id="profileToggle" type="button" class="btn p-0 position-fixed" style="top:1rem; right:1rem; z-index:1050;"
        aria-label="í”„ë¡œí•„ ì—´ê¸°">
        <img src="{{ url_for('static', filename='profile_images/' ~ current_user.profile_image) }}" alt="í”„ë¡œí•„" width="40"
            height="40" class="rounded-circle border border-2">
    </button>

    <!-- 2) Profile Toast -->
    <div id="profileToast" class="toast align-items-start text-dark bg-white border-0" role="alert"
        aria-live="assertive" aria-atomic="true" data-bs-autohide="false"
        style="position: fixed; top: 5rem; right: 1rem; min-width: 220px;">
        <div class="toast-header border-0">
            <strong class="me-auto">ë‚´ í”„ë¡œí•„</strong>
            <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="ë‹«ê¸°"></button>
        </div>
        <div class="toast-body text-center">
            <img src="{{ url_for('static', filename='profile_images/' ~ current_user.profile_image) }}" alt="í”„ë¡œí•„"
                width="64" height="64" class="rounded-circle mb-2">
            <p class="mb-2">{{ current_user.username }}</p>
            <a href="{{ url_for('logout') }}"
                class="btn btn-sm btn-primary w-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-box-arrow-right me-1"></i> ë¡œê·¸ì•„ì›ƒ
            </a>
        </div>
    </div>
    <script>
        <!-- 3) Bootstrap JS ì´ˆê¸°í™” -->
        document.addEventListener('DOMContentLoaded', function () {
            const toastEl = document.getElementById('profileToast');
            const profileToast = new bootstrap.Toast(toastEl);

            document.getElementById('profileToggle')
                .addEventListener('click', () => {
                    if (toastEl.classList.contains('show')) {
                        profileToast.hide();
                    } else {
                        profileToast.show();
                    }
                });
        });

        function goToPage(pageNum) {
            const iframe = document.querySelector('.pdf-viewer iframe');
            if (!iframe) return;
            const base = iframe.src.split('#')[0];
            console.log("iframe src before:", iframe.src, "| base:", base, "| target page:", pageNum);
            iframe.src = `${base}#page=${pageNum}`;
        }

        //  Socket.IO í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” 
        const socket = io();
        let currentAiMessageDiv = null; 
        const chatBox = document.querySelector('.chat-box');
        const chatHistory = document.querySelector('.chat-history');
        const pdfProcessingMessage = document.getElementById('pdf-processing-message'); 

        function initializeChatState() {
            
            const chatContainer = document.querySelector('.chat-history'); 
            if (!chatContainer) return; // ì±„íŒ…ì°½ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

            const existingBubbles = chatContainer.querySelectorAll('.chat-bubble');
            console.log(`[ìƒíƒœ ì´ˆê¸°í™”] ${existingBubbles.length}ê°œì˜ ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`);

            
            if (existingBubbles.length > 0) {
                
                const mainContainer = document.querySelector('.gemini-center-container');
                if (mainContainer) {
                    mainContainer.classList.add('active-chat');
                    console.log("[ìƒíƒœ ì´ˆê¸°í™”] ì±„íŒ… ê¸°ë¡ì´ ì¡´ì¬í•˜ì—¬ 'active-chat' ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.");
                }

                
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    console.log("[ìƒíƒœ ì´ˆê¸°í™”] ì±„íŒ…ì°½ì„ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í–ˆìŠµë‹ˆë‹¤.");
                }, 0); 
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€í•˜ê³  ìŠ¤í¬ë¡¤í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ 
        function appendChatMessage(role, message, isStreaming = false) {
            console.log("[appendChatMessage] role:", role, "| message:", message);
            console.log("chatHistory DOM:", chatHistory);
            hideTypingIndicator();

            if (role === 'ai' && isStreaming) {
                if (!currentAiMessageDiv) {
                    const newMessageDiv = document.createElement('div');
                    newMessageDiv.className = `chat-bubble ai`;
                    newMessageDiv.innerHTML = `<div class="message bg-white border-start border-primary border-4 shadow-sm">
            ${message.replace(/\r?\n/g, '<br>')}</div>`;
                    chatHistory.appendChild(newMessageDiv);
                    currentAiMessageDiv = newMessageDiv;
                } else {
                    currentAiMessageDiv.querySelector('.message').innerHTML += message.replace(/\r?\n/g, '<br>');
                }
            } else {
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = `chat-bubble ${role}`;

                let messageClass = '';
                if (role === 'system') {
                    messageClass = 'bg-white border-start border-primary border-4 shadow-sm';
                } else if (role === 'ai') {
                    messageClass = 'bg-white border-start border-primary border-4 shadow-sm';
                }

                newMessageDiv.innerHTML = `<div class="message ${messageClass}">${message.replace(/\r?\n/g, '<br>')}</div>`;
                chatHistory.appendChild(newMessageDiv);
                if (role === 'ai') {
                    currentAiMessageDiv = null; 
                }
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }


        //  íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í•¨ìˆ˜ 
        let typingIndicatorElement;

        function getOrCreateTypingIndicator() {
            if (!typingIndicatorElement) {
                typingIndicatorElement = document.createElement('div');
                typingIndicatorElement.className = 'chat-bubble typing-indicator';

                const avatarImg = document.createElement('img');
                avatarImg.src = "/static/img/ai-avatar.png"; 
                avatarImg.className = "ai-avatar-img";
                avatarImg.style.width = "42px";
                avatarImg.style.height = "42px";
                avatarImg.style.borderRadius = "50%";
                avatarImg.style.marginRight = "14px";

                const msgDiv = document.createElement('div');
                msgDiv.className = "message bg-white border-start border-primary border-4 shadow-sm d-flex align-items-center";
                msgDiv.innerHTML = `
        <span>AIê°€ ì…ë ¥ ì¤‘</span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        `;

                typingIndicatorElement.appendChild(avatarImg);
                typingIndicatorElement.appendChild(msgDiv);
                typingIndicatorElement.style.display = 'none';
            }
            return typingIndicatorElement;
        }
        function showTypingIndicator() {
            // 1. ê¸°ì¡´ ì¸ë””ì¼€ì´í„° ëª¨ë‘ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            const prev = document.querySelector('.typing-indicator-bubble');
            if (prev && prev.parentNode) prev.parentNode.removeChild(prev);

            // 2. ìƒˆ ì¸ë””ì¼€ì´í„° ìƒì„±
            const indicator = getOrCreateTypingIndicator();
            indicator.classList.add('typing-indicator-bubble');
            indicator.style.display = 'flex';

            // 3. ì±„íŒ… ë§¨ ì•„ë˜ì— ë¶™ì´ê¸°
            chatHistory.appendChild(indicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }


        function hideTypingIndicator() {
            console.log("[hideTypingIndicator] í˜¸ì¶œë¨");
            const indicator = document.querySelector('.typing-indicator-bubble');
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator); 
                console.log("[UI Update] íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì‚­ì œ.");
            }
        }


        // ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë™ì ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” í•¨ìˆ˜ (ì´ë²¤íŠ¸ ìœ„ì„ ì ìš©) 
        function attachRecommendedQuestionListeners() {
            if (!chatBox) {
                console.error("[ì´ë²¤íŠ¸ ì—°ê²° ì˜¤ë¥˜] chat-box ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            chatBox.addEventListener('click', function (event) {
                const clickedButton = event.target.closest('.recommended-question-btn');

                if (clickedButton) {
                    event.preventDefault();

                    const questionText = clickedButton.dataset.question;

                    appendChatMessage('user', questionText);
                    showTypingIndicator();

                    const currentPdfPathInput = document.getElementById('currentPdfPathInput');
                    const currentPdfPath = currentPdfPathInput ? currentPdfPathInput.value : '';

                    console.log(`[ì¶”ì²œ ì§ˆë¬¸ í´ë¦­] ì§ˆë¬¸: "${questionText}"`);
                    console.log(`[ì¶”ì²œ ì§ˆë¬¸ í´ë¦­] í˜„ì¬ PDF ê²½ë¡œ: "${currentPdfPath}"`);

                    socket.emit('send_question', {
                        user_question: questionText,
                        pdf_path: currentPdfPath
                    });
                    console.log("[ì¶”ì²œ ì§ˆë¬¸ í´ë¦­] Socket.IO 'send_question' ì´ë²¤íŠ¸ ì „ì†¡ ì™„ë£Œ.");
                }
            });
            console.log("[ì´ë²¤íŠ¸ ì—°ê²°] ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ìœ„ì„ ë¦¬ìŠ¤ë„ˆê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        window.addEventListener('DOMContentLoaded', function () {
            console.log("--- DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ ---");

            initializeChatState();

            hideChatLoadingOverlay();
            hideTypingIndicator();

            if (chatHistory) {
                setTimeout(() => {
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    console.log("ì±„íŒ… ê¸°ë¡ ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ ì´ë™.");
                }, 0);
            }

            const storedQuestions = localStorage.getItem('pdfRecommendedQuestions');

            console.log("[LocalStorage] ë¶ˆëŸ¬ì˜¨ ì§ˆë¬¸ (pdfRecommendedQuestions):", storedQuestions);

            attachRecommendedQuestionListeners();
        });

        document.addEventListener("DOMContentLoaded", function () {
            const addDocumentBtn = document.getElementById("addDocumentBtn");
            if (addDocumentBtn) {
                addDocumentBtn.addEventListener("click", function () {
                    document.getElementById("pdfInput").click();
                    console.log("['ë¬¸ì„œ ì¶”ê°€' ë²„íŠ¼] í´ë¦­ë¨.");
                });
            } else {
                console.error("ì˜¤ë¥˜: 'ë¬¸ì„œ ì¶”ê°€' ë²„íŠ¼ (#addDocumentBtn)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }

            $(document).ready(function () {
                var socket = io();

                socket.on('connect', function () {
                    console.log('[Socket.IO] âœ… ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                });

                socket.onAny((eventName, ...args) => {
                    console.log(`[Socket.IO ì´ë²¤íŠ¸ ìˆ˜ì‹  ğŸ“¡] ì´ë²¤íŠ¸ëª…: "${eventName}"`, args);
                });

                socket.on('summary_updated', function (data) {
                    console.log('âœ… "summary_updated" ì‹ í˜¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤! í™”ë©´ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', data);
                    window.location.reload();

                    try {
                        const loading = document.getElementById('loading-indicator');
                        if (loading) loading.style.display = 'none';

                        if (data && data.summary) {
                            const summaryContainer = document.getElementById('summary-container');
                            const summaryContent = document.getElementById('summary-content');
                            summaryContent.innerHTML = data.summary.replace(/\n/g, '<br>');
                            summaryContainer.style.display = 'block';
                        }

                        if (data && Array.isArray(data.questions)) {
                            const chatHistory = document.querySelector('.chat-history');
                            const old = chatHistory.querySelector('.chat-bubble.ai.recommendations');
                            if (old) old.remove();

                            const bubble = document.createElement('div');
                            bubble.className = 'chat-bubble ai recommendations';
                            let html = `<div class="message bg-white border-start border-primary border-4 shadow-sm">
            <div class="fw-bold mb-2">ğŸ“Œ ì¶”ì²œ ì§ˆë¬¸:</div>
            <div class="d-flex flex-wrap gap-2">`;
                            data.questions.forEach(q => {
                                html += `<button type="button" class="btn btn-outline-secondary btn-sm recommended-question-btn"
                    data-question="${q.text}">
                    ${q.text}
                </button>`;
                            });
                            html += ` </div>
        </div>`;
                            bubble.innerHTML = html;
                            chatHistory.appendChild(bubble);
                            chatHistory.scrollTop = chatHistory.scrollHeight;
                        }

                        if (data && data.message) {
                            appendChatMessage('system', data.message);
                        }

                    } catch (e) {
                        console.error('ğŸš¨ summary_updated ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
                    }
                });
                socket.on('update_failed', function (data) {
                    console.error('ğŸš¨ ì„œë²„ì—ì„œ ë¶„ì„ ì‹¤íŒ¨ ì‹ í˜¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤:', data);
                    if (data && data.message) {
                        addMessageToChat('ì‹œìŠ¤í…œ', 'ì˜¤ë¥˜: ' + data.message);
                    }
                    $('#loading-indicator').hide();
                });

            });


            document.getElementById("pdfInput").addEventListener("change", function () {
                console.log("[PDF ì—…ë¡œë“œ] PDF íŒŒì¼ ì„ íƒë¨. ì—…ë¡œë“œ ì‹œì‘.");
                showPdfProcessing();
                const form = document.getElementById("uploadForm");
                const formData = new FormData(form);

                //  ë¬¸ì„œ ìš”ì•½ ë¡œë”© ìŠ¤í”¼ë„ˆ ë©”ì‹œì§€ í‘œì‹œ 
                if (pdfProcessingMessage) {
                    pdfProcessingMessage.style.display = 'flex'; 
                    chatHistory.scrollTop = chatHistory.scrollHeight; 
                    console.log("[PDF ì—…ë¡œë“œ] 'ë¬¸ì„œ ìš”ì•½ ì¤‘...' ë©”ì‹œì§€ í‘œì‹œ.");
                }


                fetch("/upload_ajax", {
                    method: "POST",
                    body: formData
                })
                    .then(res => {
                        console.log("[Fetch ì‘ë‹µ] Fetch ì‘ë‹µ ë°›ìŒ:", res);
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log("[Fetch ë°ì´í„°] Fetch ë°ì´í„° ìˆ˜ì‹ :", data);
                        if (data.status === "ok" || data.status === "processing" || data.status === "new" || data.status === "same") {
                            localStorage.setItem('pdfRecommendedQuestions', JSON.stringify(data.question));
                            console.log("[LocalStorage] ì§ˆë¬¸ ì €ì¥ ì™„ë£Œ.");

                            const pdfViewer = document.querySelector(".pdf-viewer");
                            const newIfram = document.createElement("iframe");
                            newIfram.id = "pdf-frame";
            
                            newIfram.src = `/static/${data.filepath}#navpanes=0`;

                            pdfViewer.innerHTML = '';
                            pdfViewer.appendChild(newIfram);
                            console.log("[PDF Viewer] PDF ë·°ì–´ ì—…ë°ì´íŠ¸ ì™„ë£Œ.");

                            const mainPdfPathInput = document.getElementById('currentPdfPathInput');
                            if (mainPdfPathInput) {
                                mainPdfPathInput.value = data.filepath;
                                console.log(`[PDF ì—…ë¡œë“œ] ë©”ì¸ í¼ì˜ pdf_path ì—…ë°ì´íŠ¸ë¨: ${mainPdfPathInput.value}`);
                            }

                            const historyList = document.getElementById('document-history-list');
                            if (historyList && data.filename) {
                                const newListItem = document.createElement('li');
                                newListItem.className = 'list-group-item small text-truncate';
                                newListItem.textContent = data.filename;
                                historyList.appendChild(newListItem);
                                console.log(`[ë¬¸ì„œ ì´ë ¥] ë¬¸ì„œ ì´ë ¥ì— '${data.filename}' ì¶”ê°€ë¨.`);
                            }

                            if (pdfProcessingMessage) {
                                pdfProcessingMessage.style.display = 'none'; 
                                console.log("[PDF ì—…ë¡œë“œ] 'ë¬¸ì„œ ìš”ì•½ ì¤‘...' ë©”ì‹œì§€ ìˆ¨ê¹€.");
                            }



                            if (data.status === "new") {
                                if (data.message) {
                                    appendChatMessage('system', data.message); 
                                }
                                if (data.summary) {
                                    appendChatMessage('system', data.summary); 
                                }
                            } else {
                                if (data.message) {
                                    appendChatMessage('system', data.message);
                                }
                            }
                        } else {
                            console.error("[Fetch ì˜¤ë¥˜] ì„œë²„ ì‘ë‹µ ìƒíƒœê°€ 'ok'/ 'processing' / 'new' / 'same'ì´ ì•„ë‹˜:", data.message);
                            localStorage.removeItem('pdfRecommendedQuestions');

                            //  ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œë”© ìŠ¤í”¼ë„ˆ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° 
                            if (pdfProcessingMessage) {
                                pdfProcessingMessage.style.display = 'none';
                                console.log("[PDF ì—…ë¡œë“œ] ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ 'ë¬¸ì„œ ìš”ì•½ ì¤‘...' ë©”ì‹œì§€ ìˆ¨ê¹€.");
                            }
                        }
                        hidePdfProcessing();
                    })
                    .catch(error => {
                        console.error("[Fetch ì˜ˆì™¸] ìš”ì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                        localStorage.removeItem('pdfRecommendedQuestions');

                        //  ì˜ˆì™¸ ë°œìƒ ì‹œ ë¡œë”© ìŠ¤í”¼ë„ˆ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                        if (pdfProcessingMessage) {
                            pdfProcessingMessage.style.display = 'none';
                            console.log("[PDF ì—…ë¡œë“œ] ì˜ˆì™¸ ë°œìƒìœ¼ë¡œ 'ë¬¸ì„œ ìš”ì•½ ì¤‘...' ë©”ì‹œì§€ ìˆ¨ê¹€.");
                        }
                        hidePdfProcessing();
                    });
            });

            document.getElementById('mainChatForm').addEventListener('submit', function (event) {
                event.preventDefault();
                console.log("[mainChatForm] í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ.");

                const userQuestionInput = this.querySelector('input[name="user_question"]');
                const questionText = userQuestionInput.value;

                if (questionText.trim() === "") {
                    console.log("[í¼ ì œì¶œ] ë¹ˆ ì§ˆë¬¸ì€ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }

                appendChatMessage('user', questionText);
                userQuestionInput.value = '';

                showTypingIndicator();

                const currentPdfPathInput = document.getElementById('currentPdfPathInput');
                const currentPdfPath = currentPdfPathInput ? currentPdfPathInput.value : '';
                console.log(`[í¼ ì œì¶œ] í˜„ì¬ PDF ê²½ë¡œ: "${currentPdfPath}"`);

                socket.emit('send_question', {
                    user_question: questionText,
                    pdf_path: currentPdfPath
                });
                console.log("[í¼ ì œì¶œ] Socket.IO 'send_question' ì´ë²¤íŠ¸ ì „ì†¡ ì™„ë£Œ.");
            });

            let aiTypingDiv = null;
            let aiTypingFullText = "";

            // AI ë‹µë³€ ì²­í¬ ìˆ˜ì‹  (ìŠ¤íŠ¸ë¦¬ë°)
            socket.on('ai_response_chunk', function (data) {
                console.log("[Socket.IO] ì²­í¬ ìˆ˜ì‹ :", data.chunk);
                hideTypingIndicator();

                if (!aiTypingDiv) {
                    const newBubble = document.createElement('div');
                    newBubble.className = 'chat-bubble ai d-flex align-items-start'; 

                    const avatarImg = document.createElement('img');
                    avatarImg.src = data.avatar || "/static/img/ai-avatar.png"; 
                    avatarImg.className = "ai-avatar-img";
                    avatarImg.style.width = "42px";
                    avatarImg.style.height = "42px";
                    avatarImg.style.borderRadius = "50%";
                    avatarImg.style.marginRight = "14px";

                    const msgDiv = document.createElement('div');
                    msgDiv.className = "message bg-white border-start border-primary border-4 shadow-sm";

                    newBubble.appendChild(avatarImg);
                    newBubble.appendChild(msgDiv);
                    document.querySelector('.chat-history').appendChild(newBubble);

                    aiTypingDiv = msgDiv;
                    aiTypingFullText = ""; 
                }

                aiTypingFullText += data.chunk;
                animateTyping(aiTypingFullText, aiTypingDiv);
            });

            socket.on('ai_response_end', function (data) {
                hideTypingIndicator();
                const finalText = data.full_text || aiTypingFullText;

                if (data.page != null && aiTypingDiv) {
                    animateTyping(
                        finalText,
                        aiTypingDiv,
                        aiTypingDiv.textContent.length,
                        function () {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary-subtle text-primary-emphasis ms-2 p-0 page-badge';
                            badge.setAttribute('data-page', data.page);
                            badge.textContent = `p.${data.page}`;
                            badge.style.cursor = 'pointer';
                            aiTypingDiv.appendChild(badge);
                            aiTypingDiv = null;
                            aiTypingFullText = "";
                        }
                    );
                } else {
                    aiTypingDiv = null;
                    aiTypingFullText = "";
                }
            });

            let typingTimer = null;

            function animateTyping(text, targetDiv = null, idx = 0, onComplete = null) {
                if (!targetDiv) {
                    let bubble = document.querySelector('.chat-bubble.ai:last-child .message');
                    if (!bubble) {
                        bubble = document.createElement('div');
                        bubble.className = "message bg-white border-start border-primary border-4 shadow-sm";
                        document.querySelector('.chat-history').appendChild(bubble);
                    }
                    targetDiv = bubble;
                }
                if (idx <= text.length) {
                    targetDiv.innerHTML = text.slice(0, idx).replace(/\n/g, '<br>');
                    chatHistory.scrollTop = chatHistory.scrollHeight; typingTimer = setTimeout(() => animateTyping(text, targetDiv,
                        idx + 1, onComplete), 12);
                } else {
                    typingTimer = null;
                    if (onComplete) onComplete();
                }
            }

            document.addEventListener('click', function (e) {
                const badge = e.target.closest('.page-badge');
                if (badge && badge.dataset.page) {
                    console.log('badge clicked:', badge.dataset.page);
                    goToPage(badge.dataset.page);
                }
            });

            function activatePageBadgeTooltips() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('.page-badge[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                    if (!bootstrap.Tooltip.getInstance(tooltipTriggerEl)) {
                        new bootstrap.Tooltip(tooltipTriggerEl);
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', activatePageBadgeTooltips);

            function showPdfProcessing() {
                document.getElementById('pdf-processing-message').style.display = 'block';
                var chatPlaceholder = document.getElementById('chat-placeholder');
                if (chatPlaceholder) chatPlaceholder.style.display = 'none';
                console.log('showPdfProcessing ì‹¤í–‰!');
            }
            function hidePdfProcessing() {
                document.getElementById('pdf-processing-message').style.display = 'none';
                var chatPlaceholder = document.getElementById('chat-placeholder');
                if (chatPlaceholder) chatPlaceholder.style.display = 'block';
                console.log('hidePdfProcessing ì‹¤í–‰!');
            }


            socket.on('connect', function () {
                console.log('[Socket.IO] ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });

            socket.on('disconnect', function () {
                console.log('[Socket.IO] ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
            });

            socket.on('connect_error', (error) => {
                console.error('[Socket.IO] ì—°ê²° ì˜¤ë¥˜:', error);
            });

        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>